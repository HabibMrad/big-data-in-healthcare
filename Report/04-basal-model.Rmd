# Capitolo 4

## Sviluppo del modello di rischio con covariate cliniche al basale

```{r message=FALSE, warning=FALSE}
library("survival")
library("survminer")
```
```{r include=FALSE}
dataset <-
  read.table(
    "../dataset.csv",
    na.strings = ".",
    sep = "\t",
    header = T,
    row.names = NULL
  )

# Rimuovo l'id della riga
dataset <- dataset[,-1]

# Prendo solo le covariate cliniche
dataset <- dataset[1:7]

# Converto le variabili categoriche in categorie numeriche
dataset$Diam <- ifelse(dataset$Diam == "<=2cm", 0, 1)
dataset$N <- ifelse(dataset$N == "<4", 0, 1)
dataset$ER <- ifelse(dataset$ER == "Negative", 0, 1)
dataset$Grade <- ifelse(dataset$Grade == "Poorly diff",
                        0,
                        ifelse(dataset$Grade == "Intermediate", 1, 2))
```
### Test non parametrici
Iniziamo testando la funzione di sopravvivenza tramite Kaplan-Meier, utilizzando come approssimatore della varianza la formula di Greenwood.
```{r}
# Kaplan-Meier
fit <- survfit(Surv(dataset$time, dataset$event) ~ 1)
par(mar = c(4, 4, 2, 2))
plot(fit, xlab = 'Tempo (mesi)', ylab = 'Probabilità di sopravvivenza')
title('Kaplan-Meier')

```
Come ci si aspetta, più passa il tempo, più la probabilità di sopravvivere dei pazienti si abbassa.

Stimiamo inoltre la funzione di azzardo cumulato usando:
\begin{itemize}
\item Lo stimatore di Aalen-Nelson
\item La relazione tra survival e azzardo $ S(t) = e^{-cumhaz(t)} $
\item L'azzardo baseline estratto dal fit di un modello nullo
\end{itemize}


```{r}
# Aalen-Nelson
na.haz <- cumsum(fit$n.event / fit$n.risk)
plot(fit$time,
     na.haz,
     type = 's',
     xlab = 'tempo (mesi) ',
     ylab = 'azzardo cumulato')
```

```{r}
# Relationship between survival and hazard
cumhaz <- -log(fit$surv)
plot(
  fit$time,
  cumhaz,
  type = 's',
  ylim = c(0, 1) ,
  xlab = 'tempo (mesi)',
  ylab = 'azzardo cumulato'
)
```

```{r}
# Baseline hazard
b.haz <- basehaz(coxph(Surv(dataset$time, dataset$event) ~ 1, method = "exact"))
plot(
  b.haz$time,
  b.haz$hazard,
  type = 's',
  xlab = 'tempo (mesi)',
  ylab = 'azzardo cumulato'
)
```
Mostriamo in un unico grafico le differenze tra i tre metodi.
```{r}
# Contrast the findings
plot(
  fit$time,
  na.haz,
  type = 's',
  xlab = 'tempo (mesi)',
  ylab = 'azzardo cumulato',
  ylim = c(0, 1)
)
points(fit$time, na.haz)
lines(fit$time, cumhaz, type = 's', col = 2)
points(fit$time, cumhaz, pch = 20, col = 2)
lines(b.haz$time, b.haz$hazard, type = 's', col = 3)
points(b.haz$time, b.haz$hazard, pch = 5, col = 3)
legend("bottomright", legend = c("Nelson-Aalen estimateì", "-log(S(t))", "Baseline hazard from Cox"),
       col=c(1, 2, 3), lty=1, pch=c(1, 20, 5))
```
Notiamo che i test proposti non differiscono quasi di nulla (Perchè ?).

### Modello di Cox al basale
Costruiamo il modello di Cox utilizzando le covariate cliniche.
```{r}
model <- coxph(formula = Surv(time, event) ~ Diam + N + ER + factor(Grade) + Age,
               data = dataset)
summary(model)
```

Dal summary del modello vediamo che Diam e N contribuiscono ad aumentare l'azzardo, mentre ER e Grade = 2 contribuiscono a diminuirlo.
Age e Grade = 1 hanno un coefficiente vicino allo zero e quindi danno un contributo quasi nullo all'azzardo.
Notiamo inoltre che i test statistici hanno una significatività molto bassa (solo un p-value < 0.05), questo è dovuto principalmente alla grandezza del dataset che limita teoricamente il numero di preditorri utilizzabili.
Per questo motivo possiamo prendere meno in considerazione i valori dei coefficienti di regressione.

In your particular application, you are under-powered to test this many coefficients. 
The usual rule of thumb in Cox or logistic regressions is to have about 15 events per predictor variable being considered. 
(For this, interaction terms count as predictor variables.) Your 53 events thus would limit you to about 3 predictors,while your model includes 6. Note that your overall model does not reach standard statistical significance 
(p-value is > 0.05 for the omnibus tests), so you should not be paying much attention to the individual regression coefficients anyway. 
This model is not significantly different, by standard frequentist criteria, from no model at all.

```{r}
ggsurvplot(
  survfit(model),
  data = dataset,
  palette = "#2E9FDF",
  ggtheme = theme_minimal()
)
```

```{r}
# Modello basale
bas <- basehaz(model, centered = FALSE)
bas.surv <- exp(-bas[, 1])
plot(
  bas$time,
  bas.surv,
  type = 's',
  col = 1,
  ylim = c(0, 1),
  xlim = c(0, 18),
  lty = 2,
  xlab = 'time',
  ylab = 'survival probability'
)
```

```{r}
# Residui di Schoenfeld
test.ph = cox.zph(model)
ggcoxzph(test.ph)
```

```{r}
# Verifica dei residui con il metodo di Lin
library(goftte)
prop(model)
```

```{r}
# Forma funzionale di age 
# Knots è un parametro che va sistemato, forse non va bene
par(mfrow = c(1, 2), mar = c(4, 4, 2, 2))
mar.res <- resid(model, type = 'martingale')
plot(dataset$Age,
     mar.res,
     xlab = "Time",
     ylab = "Martingale Residuals",
     main = "Check functional form of age")
lines(lowess(dataset$Age, mar.res), col = 'red')

library(splines)
ms <- coxph(Surv(time, event > 0) ~ ns(Age, knots = c(20, 35, 45)), data = dataset)
pred <- predict(ms, type = "terms", se = TRUE)
hfit <- pred$fit[, 1]
hse <- pred$se[, 1]
hmat <- cbind(hfit, hfit + 1.96 * hse, hfit - 1.96 * hse)
o <- order(dataset$Age)
matplot(
  dataset$Age[o],
  hmat[o,],
  pch = "*",
  col = c("red", "orangered", "orangered"),
  lwd = c(2, 1, 1),
  xlab = "Age",
  ylab = "log hazard ratio",
  main = "Check functional form of Age",
  type = "l"
)

ms <- coxph(Surv(time, event > 0) ~ Age, data = dataset)
pred <- predict(ms, type = "terms", se = TRUE)
hfit <- pred$fit[, 1]
hse <- pred$se[, 1]
hmat <- cbind(hfit, hfit + 1.96 * hse, hfit - 1.96 * hse)
o <- order(dataset$Age)
matplot(
  dataset$Age[o],
  hmat[o,],
  pch = "*",
  col = c("blue", "cornflowerblue", "cornflowerblue"),
  lwd = c(2, 1, 1),
  type = "l",
  add = T
)

legend(
  "topright",
  c("natural spline", "linear"),
  col = c(2, 4),
  lwd = 2,
  bty = "n"
)
```
